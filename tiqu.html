<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>拼合的 - 优化版</title>
    <script src="./fabric.min.js"></script>
    <script src="./Sortable.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --success: #10b981;
            --danger: #ef4444;
            --sidebar-bg: #111827;
            --card-bg: #1f2937;
            --input-bg: #030712;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --radius: 12px;
            --font-family: "SF Pro SC","SF Pro Text","SF Pro Icons","PingFang SC","Microsoft YaHei","微软雅黑",Verdana,Arial,sans-serif;
        }

        body {
            font-family: var(--font-family);
            margin: 0; display: flex; height: 100vh;
            background-color: #e5e7eb;
            background-image: radial-gradient(#d1d5db 1px, transparent 1px);
            background-size: 24px 24px;
            color: var(--text-main);
            overflow: hidden;
        }

        /* 优化：侧边栏增加最小宽度限制，防止挤压 */
        .sidebar {
            width: 25vw;
            min-width: 320px;
            max-width: 400px;
            background: var(--sidebar-bg);
            display: flex; flex-direction: column;
            box-shadow: 10px 0 30px rgba(0,0,0,0.2); z-index: 20;
            border-right: 1px solid rgba(255,255,255,0.05);
        }

        .sidebar-header { padding: 30px 24px; flex-shrink: 0; }
        .sidebar-header h2 { margin: 0; font-size: 1.5rem; font-weight: 800; color: #fff; }

        .sidebar-content { padding: 0 24px 24px 24px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }

        .tab-group { display: flex; background: var(--input-bg); padding: 5px; border-radius: var(--radius); flex-shrink: 0; }
        .tab { flex: 1; text-align: center; padding: 10px; font-size: 13px; cursor: pointer; border-radius: 8px; color: var(--text-muted); transition: 0.3s; }
        .tab.active { background: var(--primary); color: white; }

        #imageList { list-style: none; padding: 0; margin: 0; }
        .img-card {
            background: var(--card-bg); border-radius: var(--radius);
            padding: 12px; display: flex; align-items: center; gap: 12px;
            margin-bottom: 12px; cursor: grab; border: 1px solid rgba(255,255,255,0.05);
        }
        .img-card img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; }

        .input-group label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
        input[type="text"] {
            background: var(--input-bg); border: 1px solid #374151;
            padding: 14px; border-radius: var(--radius); color: white; width: 100%; box-sizing: border-box;
        }

        .btn { padding: 14px 20px; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 700; width: 100%; transition: 0.2s; }
        .btn-upload { background: rgba(255,255,255,0.05); color: white; border: 1px dashed rgba(255,255,255,0.2); }
        .btn-save { background: var(--primary); color: white; margin-top: 10px; margin-bottom: 10px; flex-shrink: 0; }
        .mini-btn { background: #374151; color: white; padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; }

        /* 优化：工作区背景 */
        .main-workspace { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; overflow: hidden; position: relative; }
        .canvas-container-outer { transform-origin: center center; box-shadow: 0 30px 60px rgba(0,0,0,0.3); background: white; transition: transform 0.2s ease-out; }

        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #ef4444; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 10px 15px rgba(0,0,0,0.2); font-weight: 600; animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="toastContainer" class="toast-container"></div>

<div class="sidebar">
    <div class="sidebar-header"><h2>拼合图工具</h2></div>
    <div class="sidebar-content">
        <div class="tab-group">
            <div id="tab-landscape" class="tab active" onclick="switchMode('landscape')">横向模式</div>
            <div id="tab-portrait" class="tab" onclick="switchMode('portrait')">纵向模式</div>
        </div>
        <button class="btn btn-upload" onclick="document.getElementById('f').click()">+ 上传图像</button>
        <input type="file" id="f" multiple accept="image/*" style="display: none;">
        <ul id="imageList"></ul>
        <div class="input-group"><label>大标题</label><input type="text" id="t1" placeholder="必填内容" oninput="updateTexts()"></div>
        <div class="input-group"><label>二标题</label><input type="text" id="t2" placeholder="必填内容" oninput="updateTexts()"></div>
        <button class="btn btn-save" onclick="save()">导出图片</button>
    </div>
</div>

<div class="main-workspace">
    <div id="canvasWrapper" class="canvas-container-outer"><canvas id="c"></canvas></div>
</div>

<script>
    let canvas, imgs = [], mode = 'landscape', isRendering = false;
    const GAP = 2;
    const DEFAULT_FONT = '"Microsoft YaHei", "微软雅黑"';

    window.onload = () => { initCanvas(); initSortable(); };
    window.onresize = () => adjustZoom();

    function showToast(msg) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerText = msg;
        container.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
    }

    function initSortable() {
        Sortable.create(document.getElementById('imageList'), {
            animation: 150,
            onEnd: function () {
                const ids = Array.from(document.querySelectorAll('.img-card')).map(li => li.getAttribute('data-id'));
                imgs.sort((a, b) => ids.indexOf(a.id.toString()) - ids.indexOf(b.id.toString()));
                updateUI();
            }
        });
    }

    function initCanvas() {
        const w = mode === 'landscape' ? 1024 : 768, h = mode === 'landscape' ? 768 : 1024;
        if (canvas) canvas.dispose();
        canvas = new fabric.Canvas('c', { width: w, height: h, backgroundColor: '#fff', preserveObjectStacking: true });
        adjustZoom();
        render(); // 只有初始化和图片变动才调 render
    }

    function adjustZoom() {
        const wrapper = document.querySelector('.main-workspace');
        if(!wrapper || !canvas) return;
        const scale = Math.min((wrapper.offsetWidth - 40) / canvas.width, (wrapper.offsetHeight - 40) / canvas.height, 1);
        document.getElementById('canvasWrapper').style.transform = `scale(${scale})`;
    }

    function switchMode(m) {
        mode = m;
        document.getElementById('tab-landscape').className = m === 'landscape' ? 'tab active' : 'tab';
        document.getElementById('tab-portrait').className = m === 'portrait' ? 'tab active' : 'tab';
        initCanvas();
    }

    document.getElementById('f').onchange = (e) => {
        const files = Array.from(e.target.files);
        let loaded = 0;
        files.forEach(file => {
            const r = new FileReader();
            r.onload = (f) => {
                imgs.push({ id: 'id_' + Date.now() + Math.random(), src: f.target.result, angle: 0 });
                loaded++;
                if(loaded === files.length) updateUI();
            };
            r.readAsDataURL(file);
        });
        e.target.value = '';
    };

    function updateUI() {
        const list = document.getElementById('imageList');
        list.innerHTML = '';
        imgs.forEach((img, i) => {
            const li = document.createElement('li');
            li.className = 'img-card';
            li.setAttribute('data-id', img.id);
            li.innerHTML = `<img src="${img.src}"><div style="flex:1;font-size:12px;color:var(--text-muted)">图层 ${i+1}</div>
                <button class="mini-btn" onclick="rotateById('${img.id}')">旋</button>
                <button class="mini-btn" onclick="delById('${img.id}')" style="background:var(--danger)">×</button>`;
            list.appendChild(li);
        });
        render();
    }

    function rotateById(id) { const t = imgs.find(x => x.id === id); if(t){t.angle=(t.angle+90)%360; render();} }
    function delById(id) { imgs = imgs.filter(x => x.id !== id); updateUI(); }

    function renderImage(data, region) {
        return new Promise(res => {
            fabric.Image.fromURL(data.src, img => {
                img.set({ angle: data.angle });
                const isRot = data.angle % 180 !== 0;
                const iW = isRot ? img.height : img.width, iH = isRot ? img.width : img.height;
                const sc = Math.max(region.w/iW, region.h/iH);
                img.set({ 
                    left: region.x + region.w/2, top: region.y + region.h/2, 
                    originX: 'center', originY: 'center', scaleX: sc, scaleY: sc,
                    selectable: true,
                    clipPath: new fabric.Rect({ left: region.x, top: region.y, width: region.w, height: region.h, absolutePositioned: true })
                });
                canvas.add(img); 
                img.sendToBack(); 
                res();
            });
        });
    }

    // 核心修改：将文字更新独立出来，避免重绘整块画布导致的闪烁
    async function updateTexts() {
        if (!canvas) return;
        const t1Val = document.getElementById('t1').value || "输入主标题";
        const t2Val = document.getElementById('t2').value || "输入副标题";
        
        let mainT = canvas.getObjects().find(obj => obj.id === 'mainTitle');
        let subT = canvas.getObjects().find(obj => obj.id === 'subTitle');

        if (mainT && subT) {
            mainT.set({ text: t1Val });
            subT.set({ text: t2Val });
            canvas.renderAll();
        } else {
            // 如果文字对象不存在（比如刚初始化），则执行完整渲染
            render();
        }
    }

    async function render() {
        if (!canvas || isRendering) return;
        isRendering = true;
        
        canvas.clear();
        canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));

        const W = canvas.width, H = canvas.height, g = GAP/2;
        const regions = [
            { x: 0, y: 0, w: W/2 - g, h: H/2 - g },
            { x: W/2 + g, y: 0, w: W/2 - g, h: H/2 - g },
            { x: W/2 + g, y: H/2 + g, w: W/2 - g, h: H/2 - g },
            { x: 0, y: H/2 + g, w: W/2 - g, h: H/2 - g }
        ];

        for (let i = 0; i < Math.min(imgs.length, 3); i++) {
            await renderImage(imgs[i], regions[i]);
        }

        const rT = regions[3];
        const padding = 30;
        const maxW = rT.w - padding * 2;

        const mainT = new fabric.Textbox(document.getElementById('t1').value || "输入主标题", {
            id: 'mainTitle', // 绑定ID以便局部更新
            left: rT.x + rT.w/2, top: rT.y + rT.h/2 - 20,
            width: maxW, fontSize: 50, fontWeight: 800, fill: '#1e293b', 
            textAlign: 'center', originX: 'center', originY: 'bottom', selectable: false,
            fontFamily: DEFAULT_FONT
        });
        
        const subT = new fabric.Textbox(document.getElementById('t2').value || "输入副标题", {
            id: 'subTitle', // 绑定ID以便局部更新
            left: rT.x + rT.w/2, top: rT.y + rT.h/2 + 10,
            width: maxW, fontSize: 40, fill: '#1e293b', 
            textAlign: 'center', originX: 'center', originY: 'top', selectable: false,
            fontFamily: DEFAULT_FONT
        });

        const now = new Date();
        const timeStr = `更新于: ${now.toLocaleString()}`;
        const timeT = new fabric.Text(timeStr, {
            left: rT.x + rT.w/2, top: rT.y + rT.h - 15,
            fontSize: 20, fill: '#94a3b8', originX: 'center', originY: 'bottom', selectable: false,
            fontFamily: DEFAULT_FONT
        });

        canvas.add(mainT, subT, timeT);
        canvas.renderAll();
        isRendering = false;
    }

    function save() {
        const t1 = document.getElementById('t1').value.trim();
        const t2 = document.getElementById('t2').value.trim();
        if (!t1 || !t2) { showToast("⚠️ 两个标题为必填项"); return; }
        const url = canvas.toDataURL({ format: 'png', multiplier: 2 });
        const link = document.createElement('a');
        link.download = `${t1}-${t2}.png`;
        link.href = url;
        link.click();
    }
</script>
</body>
</html>